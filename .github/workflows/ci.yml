name: CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'LICENSE'

env:
  PYTHON_VERSION: "3.12"  # HA 2025+ standard

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # Enhanced multi-layer caching
    - name: Cache dependencies and test results
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.cache/pytest
          .pytest_cache
          __pycache__
        key: ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-deps-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-deps-
          ${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install -e ".[dev]" --prefer-binary

    # Parallel test execution with pytest-xdist
    - name: Run tests with coverage (parallel)
      run: |
        pip install pytest-xdist
        pytest tests/ --cov=custom_components.wrtmanager --cov-report=xml --cov-report=term-missing -n auto --maxfail=3 --tb=short

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # Cache lint tools specifically
    - name: Cache lint dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
        key: ${{ runner.os }}-lint-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-lint-${{ env.PYTHON_VERSION }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel
        pip install -e ".[dev]" --prefer-binary

    # Run linting in parallel where possible
    - name: Run all linting checks
      run: |
        # Run independent checks in parallel
        echo "Running Black..." && black --check custom_components/ tests/ &
        PID1=$!
        echo "Running isort..." && isort --check-only custom_components/ tests/ &
        PID2=$!
        echo "Running flake8..." && flake8 custom_components/ tests/ --max-line-length=100 --extend-ignore=E203,W503 &
        PID3=$!

        # Wait for parallel jobs and collect results
        wait $PID1 && echo "✅ Black passed" || { echo "❌ Black failed" && EXIT_CODE=1; }
        wait $PID2 && echo "✅ isort passed" || { echo "❌ isort failed" && EXIT_CODE=1; }
        wait $PID3 && echo "✅ flake8 passed" || { echo "❌ flake8 failed" && EXIT_CODE=1; }

        # Run pylint separately (sequential for better error messages)
        echo "Running pylint..."
        pylint custom_components/ --disable=all --enable=unused-import,undefined-variable && echo "✅ pylint passed" || { echo "❌ pylint failed" && EXIT_CODE=1; }

        exit ${EXIT_CODE:-0}

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # Cache security tools
    - name: Cache security tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python${{ env.PYTHON_VERSION }}/site-packages
        key: ${{ runner.os }}-security-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-security-${{ env.PYTHON_VERSION }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel
        pip install safety bandit --prefer-binary

    # Run security scans in parallel
    - name: Run security checks in parallel
      run: |
        echo "Running safety check..." && safety check &
        PID1=$!
        echo "Running bandit scan..." && bandit -r custom_components/ -f json -o bandit-report.json &
        PID2=$!

        wait $PID1 && echo "✅ Safety check passed" || echo "⚠️ Safety issues found"
        wait $PID2 && echo "✅ Bandit scan completed"

    - name: Upload bandit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-results
        path: bandit-report.json

  home-assistant-validation:
    name: Home Assistant Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate manifest.json
      run: |
        python -c "
        import json
        with open('custom_components/wrtmanager/manifest.json') as f:
            manifest = json.load(f)

        required_keys = ['domain', 'name', 'version', 'documentation', 'codeowners', 'requirements']
        for key in required_keys:
            assert key in manifest, f'Missing required key: {key}'

        print('✅ manifest.json validation passed')
        "

    - name: Check HACS compliance
      run: |
        # Basic HACS structure validation
        test -f custom_components/wrtmanager/__init__.py
        test -f custom_components/wrtmanager/manifest.json
        test -f README.md
        test -f LICENSE
        echo "✅ HACS structure validation passed"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run integration tests (if available)
      run: |
        if [ -f "tests/integration/" ]; then
          pytest tests/integration/ -v -m integration
        else
          echo "No integration tests found - skipping"
        fi

  build-check:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # Cache build tools
    - name: Cache build tools
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-build-tools-${{ env.PYTHON_VERSION }}
        restore-keys: |
          ${{ runner.os }}-build-tools-

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip wheel
        pip install build --prefer-binary

    - name: Build package
      run: python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/

  release-check:
    name: Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [test, lint, security, home-assistant-validation]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check version consistency
      run: |
        MANIFEST_VERSION=$(python -c "import json; print(json.load(open('custom_components/wrtmanager/manifest.json'))['version'])")
        PYPROJECT_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")

        if [ "$MANIFEST_VERSION" != "$PYPROJECT_VERSION" ]; then
          echo "❌ Version mismatch: manifest.json ($MANIFEST_VERSION) vs pyproject.toml ($PYPROJECT_VERSION)"
          exit 1
        fi

        echo "✅ Version consistency check passed: $MANIFEST_VERSION"

    - name: Check changelog
      run: |
        if [ ! -f CHANGELOG.md ]; then
          echo "⚠️  CHANGELOG.md not found"
        else
          echo "✅ CHANGELOG.md exists"
        fi