name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=custom_components.wrtmanager --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check code formatting with Black
      run: black --check custom_components/ tests/

    - name: Check import sorting with isort
      run: isort --check-only custom_components/ tests/

    - name: Lint with flake8
      run: flake8 custom_components/ tests/ --max-line-length=100 --extend-ignore=E203,W503

    - name: Type check with mypy
      run: mypy custom_components/ --ignore-missing-imports

    - name: Lint with pylint
      run: pylint custom_components/ --disable=all --enable=unused-import,undefined-variable

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install safety bandit

    - name: Run safety check
      run: safety check

    - name: Run bandit security linter
      run: bandit -r custom_components/ -f json -o bandit-report.json || true

    - name: Upload bandit results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-results
        path: bandit-report.json

  home-assistant-validation:
    name: Home Assistant Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate manifest.json
      run: |
        python -c "
        import json
        with open('custom_components/wrtmanager/manifest.json') as f:
            manifest = json.load(f)

        required_keys = ['domain', 'name', 'version', 'documentation', 'codeowners', 'requirements']
        for key in required_keys:
            assert key in manifest, f'Missing required key: {key}'

        print('✅ manifest.json validation passed')
        "

    - name: Check HACS compliance
      run: |
        # Basic HACS structure validation
        test -f custom_components/wrtmanager/__init__.py
        test -f custom_components/wrtmanager/manifest.json
        test -f README.md
        test -f LICENSE
        echo "✅ HACS structure validation passed"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run integration tests (if available)
      run: |
        if [ -f "tests/integration/" ]; then
          pytest tests/integration/ -v -m integration
        else
          echo "No integration tests found - skipping"
        fi

  build-check:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: dist/

  release-check:
    name: Release Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [test, lint, security, home-assistant-validation]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check version consistency
      run: |
        MANIFEST_VERSION=$(python -c "import json; print(json.load(open('custom_components/wrtmanager/manifest.json'))['version'])")
        PYPROJECT_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")

        if [ "$MANIFEST_VERSION" != "$PYPROJECT_VERSION" ]; then
          echo "❌ Version mismatch: manifest.json ($MANIFEST_VERSION) vs pyproject.toml ($PYPROJECT_VERSION)"
          exit 1
        fi

        echo "✅ Version consistency check passed: $MANIFEST_VERSION"

    - name: Check changelog
      run: |
        if [ ! -f CHANGELOG.md ]; then
          echo "⚠️  CHANGELOG.md not found"
        else
          echo "✅ CHANGELOG.md exists"
        fi